Feature Name: Wormhole
Start Date: 2018-10-03
RFC PR:
Issue:

# Summary
Wormhole is a new CNI network plugin, to encrypt traffic within a kubernetes cluster, based on WireGuard (https://www.wireguard.com)


This spec is not complete.

# Motivation
Several customers have approached us, asking to support encrypted networking between hosts when running gravity clusters in zero trust networks.

We are looking for a solution that has the following properties:
- Can be totally automated, and is easy to troubleshoot via remote support
- Is simple to turn-on, and will just work for a majority of use cases
- Encrypts all pod-to-pod traffic with minimal configuration

By introducing a CNI plugin based on wireguard, we can create a simple to understand and troubleshoot encrypted overlay network between hosts, that operates transparently to any deployed application.

# Guide-level explanation
This feature allows customers to optionally enable an encrypted overlay network within a [gravity cluster.](https://github.com/gravitational/gravity)

## Non-Goals:

- Multicast / broadcast network traffic will not be supported
- Network policy (use a network policy controller such as kube-router or canal along with this plugin)
- Non-amd64 platforms
- IPv6
- Identity (as in server/client certs)


## Installation

### Gravity
TBD

Note: This still needs to be looked at in greater detail. 

### Non-gravity cluster
```
kubectl apply -f https://raw.githubusercontent.com/gravitational/wormhole/v0.0.0/docs/kube-wormhole.yaml
```
- Note: this will require installation of the wireguard kernel module on the host
- Note: On a kubeadm install, this will require passing --pod-network-cidr=<range> on init to enable the kubernetes IPAM

## Upgrade

### Gravity
- Gravity will upgrade wormhole naturally, as part of it's upgrade process

### Non-Gravity cluster
```
kubectl apply -f https://raw.githubusercontent.com/gravitational/wormhole/v1.0.0/docs/kube-wormhole.yaml
```

## Metrics
A limited set of metrics will be available via a prometheus endpoint.

Metrics:
- Software version
- Traffic counts between each node pair
- Error / Operational Status
- TODO (Packet loss between hosts)

Security:
- The prometheus endpoint should support mTLS client authentication

## Debug

### Logs
Most status / health information will be logged as part of the daemon / pod logs

### Status
Wireguard CLI (wg) will be embedded in the wormhole container, as well as planet, and can be used to inspect the wireguard tunnels easily.

TODO: Wormhole may include it's own status overview

### Docs
Troubleshooting docs similar to other plugins will need to be included

## Health Checks [(Satellite)](https://github.com/gravitational/satellite)
Satellite will monitor the prometheus endpoint and report the following conditions:
- Host-to-host connectivity failures (ping / last handshake time)
- Missing peers (as compared to the k8s API)
- Daemon Errors
- Packet loss / latency

# Reference-level explanation
## Why WireGuard?
Wireguard is a lightweight VPN technology that has been getting many accolades and is currently expected to be mainlined into the Linux kernel. Itâ€™s designed to replace IPsec and OpenVPN for most use cases while being more secure, more performant, and easier to use.

The WireGuard paper provides a detailed explanation of the choices and properties offered by wireguard: https://www.wireguard.com/papers/wireguard.pdf

At Gravitational, our experience has consistently shown that simpler is better when operating overlay networks in many different clouds and on-prem environments, and WireGuard is especially appealing as a simple, highly opinionated, and highly performant network encryption solution that will allow us to continue to use the simpler is the better model.

## What about x?
There are a number of fascinating encrypted network plugins already available, that cover various features and capabilities that are not covered by wormhole.

The reason for us to introduce another network plugin, comes down to our experience shows when running clusters in hostile networks, that the simpler we can keep the networking model, the easier it is to troubleshoot in air-gapped, restricted access, networks.

So this plugin is for the use case, where a simple plugin is needed, but also to offer encrypted traffic between hosts.

## Architecture

![wormhole architecture]()
